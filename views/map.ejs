<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa interactivo</title>
  <style>
    .tooltip-box:hover title {
      display: block;
    }
    svg {
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h1>Mapa de la nave</h1>
  <p>Bienvenido, <%= usuario.nombre %></p>

  <svg width="800" height="600" xmlns="http://www.w3.org/2000/svg">
    <image xlink:href="<%= mapa.imagen_url %>" width="800" height="600" />
    <% puntos.forEach(p => { %>
      <g id="punto-<%= p.id %>" class="tooltip-box" aria-label="Punto <%= p.nombre %>">
        <rect x="<%= p.x %>" y="<%= p.y %>" width="<%= p.ancho %>" height="<%= p.alto %>" fill="yellow" />
        <title>Sin revisión</title>
      </g>
    <% }) %>
  </svg>

  <script>
    async function actualizarEstados() {
  try {
    const respuesta = await fetch('/map/api/estados-puntos');
    
    if (!respuesta.ok) {
      if (respuesta.status === 401) {
        console.warn('Sesión expirada. Redirigiendo al login...');
        window.location.href = '/auth/login?redirect=' + encodeURIComponent(location.pathname);
        return;
      } else {
        throw new Error('Error de servidor');
      }
    }

    const datos = await respuesta.json();
    datos.forEach(p => {
      const grupo = document.getElementById(`punto-${p.id}`);
      if (grupo) {
        const rect = grupo.querySelector('rect');
        const title = grupo.querySelector('title');
        rect.setAttribute('fill', p.color);
        title.textContent = p.tooltip;
      }
    });
  } catch (err) {
    console.error('Error al actualizar puntos:', err);
  }
}

    setInterval(actualizarEstados, 10000);
    actualizarEstados();
  </script>
</body>
</html>
